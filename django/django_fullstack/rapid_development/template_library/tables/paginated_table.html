<!-- ðŸ“Š PAGINATED TABLE - Advanced Table with Pagination -->

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All {{ item_name }}s</h5>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="itemsPerPage" onchange="changeItemsPerPage()">
                <option value="10" {% if items_per_page == 10 %}selected{% endif %}>10 per page</option>
                <option value="25" {% if items_per_page == 25 %}selected{% endif %}>25 per page</option>
                <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100 per page</option>
            </select>
            <a href="/{{ item_name }}/new" class="btn btn-primary btn-sm">Add New</a>
        </div>
    </div>
    <div class="card-body">
        {% if all_items %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>
                            <a href="?sort=name&order={{ sort_order|default:'asc' }}" class="text-white text-decoration-none">
                                Name {% if sort_by == 'name' %}{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort=description&order={{ sort_order|default:'asc' }}" class="text-white text-decoration-none">
                                Description {% if sort_by == 'description' %}{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort=created_at&order={{ sort_order|default:'asc' }}" class="text-white text-decoration-none">
                                Created {% if sort_by == 'created_at' %}{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort=status&order={{ sort_order|default:'asc' }}" class="text-white text-decoration-none">
                                Status {% if sort_by == 'status' %}{% if sort_order == 'asc' %}â†‘{% else %}â†“{% endif %}{% endif %}
                            </a>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in all_items %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 32px; height: 32px;">
                                        <span class="text-white fw-bold">{{ item.name|first|upper }}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ item.name }}</div>
                                    <small class="text-muted">ID: {{ item.id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ item.description|truncatechars:60 }}</td>
                        <td>
                            <div>{{ item.created_at|date:"M j, Y" }}</div>
                            <small class="text-muted">{{ item.created_at|timesince }} ago</small>
                        </td>
                        <td>
                            <span class="badge bg-{{ item.status|yesno:'success,danger' }}">
                                {{ item.status|yesno:'Active,Inactive' }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="/{{ item_name }}/{{ item.id }}" class="btn btn-outline-primary" 
                                   data-bs-toggle="tooltip" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="/{{ item_name }}/{{ item.id }}/edit" class="btn btn-outline-warning"
                                   data-bs-toggle="tooltip" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="deleteItem({{ item.id }})" data-bs-toggle="tooltip" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Table pagination">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">Previous</a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">Last</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        
        <!-- Pagination Info -->
        <div class="text-center text-muted">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} {{ item_name }}s
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <div class="mb-3">
                <i class="fas fa-inbox fa-3x text-muted"></i>
            </div>
            <h5 class="text-muted">No {{ item_name }}s found</h5>
            <p class="text-muted">Get started by adding your first {{ item_name }}.</p>
            <a href="/{{ item_name }}/new" class="btn btn-primary">Add New {{ item_name }}</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Bulk Actions -->
{% if all_items %}
<div class="card shadow-sm mt-3">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    <label class="form-check-label" for="selectAll">
                        Select All
                    </label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="bulkAction">
                        <option value="">Bulk Actions</option>
                        <option value="activate">Activate Selected</option>
                        <option value="deactivate">Deactivate Selected</option>
                        <option value="delete">Delete Selected</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="performBulkAction()">
                        Apply
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- JavaScript for Table Functionality -->
<script>
// Delete item function
function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item?')) {
        fetch(`/delete-item/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting item');
            }
        });
    }
}

// Change items per page
function changeItemsPerPage() {
    const itemsPerPage = document.getElementById('itemsPerPage').value;
    const url = new URL(window.location);
    url.searchParams.set('per_page', itemsPerPage);
    url.searchParams.set('page', '1'); // Reset to first page
    window.location.href = url.toString();
}

// Toggle select all
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('input[type="checkbox"][name="item_ids"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Perform bulk action
function performBulkAction() {
    const action = document.getElementById('bulkAction').value;
    const selectedItems = Array.from(document.querySelectorAll('input[type="checkbox"][name="item_ids"]:checked'))
        .map(checkbox => checkbox.value);
    
    if (!action) {
        alert('Please select an action');
        return;
    }
    
    if (selectedItems.length === 0) {
        alert('Please select at least one item');
        return;
    }
    
    if (confirm(`Are you sure you want to ${action} ${selectedItems.length} item(s)?`)) {
        fetch('/bulk-action/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: action,
                item_ids: selectedItems
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error performing bulk action');
            }
        });
    }
}

// CSRF Token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
